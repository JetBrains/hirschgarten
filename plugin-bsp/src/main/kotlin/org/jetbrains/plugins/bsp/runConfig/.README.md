# Run configurations refactor overview

```
this.busFactor--;
```

## Terminology

### RunConfiguration
`RunConfiguration` - a "target" that can be executed, joined together with some properties/settings *and*
the means to actually execute it.

In our case here are two types of run configurations:
- one for running a binary/program/executable. We ask the BSP server to run it for us and simply capture the output.
- one for running tests. This needs special handling, because there's a different IntelliJ console for tests.

This distinction is orthogonal to BSP's distinction between `run` and `test` endpoints. 
You can run a test with `run` (try it in Bazel!), because tests are usually just binaries 
with some special test harness.

From IntelliJ's point of view, the difference between a test and a binary is that they have different consoles.

All RunConfigurations are run by clicking the green triangle in the gutter/upper toolbar. Notice that the UI
is the same for all run configurations (i.e. there's no separate button for running tests).

We could possibly have `RunConfiguration` for more general things. For example, Gradle allows you to run 
arbitrary tasks, which are not binaries or tests. 
They can even modify the project itself! (for example, run a formatter)

![](run_toolbar.png)

There are some other buttons in the RunConfiguration toolbar.
There's `Debug`, `Run with Coverage` and (sometimes?) `Run with Profiler`.
They *run* the same configuration, but using a different **Executor**.


## Classes

To understand what's going on and why we need so much boilerplate, please read
[this article](https://plugins.jetbrains.com/docs/intellij/run-configuration-execution.html).

### BspRunStateBase
We use this instead of `CommandLineState` because `CommandLineState` assumes that there's a separate 
process that we need to start and wait for. In our case, we don't need to start a separate process.
The instances of this class manage their own console. I **think** this fixes the issue with the console not being
brought to the front when you click the green triangle.
Previously there existed a "service" for console management, but it was a hacky solution.

### BspProcessHandler
Note that we don't spawn any OS processes here. We delegate to the BSP server to do that.
(Otherwise we would extend `OSProcessHandler` instead.)
We handle a "logical" process here. That "process" is tied to BSP's task lifetime. 

#### Cancellation
If the protocol supported run cancellation (which we should add at some point),
we would implement that here. User can cancel the run by clicking the stop button.
Any subsequent clicks should *kill* the process instead. If we implement killing, we should
implement `KillableProcess` to enable this feature in the UI.