<idea-plugin>
    <!-- Do NOT put <id> and <name> here, it will be provided by the xml generated by rules_intellij -->
    <!-- which will be merged with this one -->
    <vendor>JetBrains</vendor>
    <extensionPoints>
        <extensionPoint qualifiedName="org.jetbrains.bsp.sourceTypeIconProvider"
                        interface="org.jetbrains.plugins.bsp.utils.SourceTypeIconProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.buildTargetClassifierExtension"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BuildTargetClassifierExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.scalaSdkExtension"
                        interface="org.jetbrains.plugins.bsp.scala.sdk.ScalaSdkExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.androidSdkGetterExtension"
                        interface="org.jetbrains.plugins.bsp.android.AndroidSdkGetterExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.androidFacetEntityUpdaterExtension"
                        interface="org.jetbrains.plugins.bsp.magicmetamodel.impl.workspacemodel.impl.updaters.AndroidFacetEntityUpdaterExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspRunHandlerProvider"
                        interface="org.jetbrains.plugins.bsp.run.BspRunHandlerProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspProjectOpenProcessorExtension"
                        interface="org.jetbrains.plugins.bsp.impl.flow.open.BspProjectOpenProcessorExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.buildToolAssetsExtension"
                        interface="org.jetbrains.plugins.bsp.assets.BuildToolAssetsExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspProjectAwareExtension"
                        interface="org.jetbrains.plugins.bsp.impl.projectAware.BspProjectAwareExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.connectionDetailsProviderExtension"
                        interface="org.jetbrains.plugins.bsp.impl.server.connection.ConnectionDetailsProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.connectionDetailsProviderExtensionJavaShim"
                        interface="org.jetbrains.plugins.bsp.impl.server.connection.ConnectionDetailsProviderExtensionJavaShim"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.buildToolWindowTargetActionProviderExtension"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BuildToolWindowTargetActionProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspToolWindowSettingsProviderExtension"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BspToolWindowSettingsProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspToolWindowConfigFileProviderExtension"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BspToolWindowConfigFileProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspProjectModelExternalSource"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BspProjectModelExternalSourceExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspRunConfigurationExtension"
                        interface="org.jetbrains.plugins.bsp.run.config.BspRunConfigurationExtensionManager"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.invalidTargetsProviderExtension"
                        interface="org.jetbrains.plugins.bsp.services.InvalidTargetsProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectSyncHook"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.ProjectSyncHook"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectPreSyncHook"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.ProjectPreSyncHook"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectPostSyncHook"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.ProjectPostSyncHook"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.defaultProjectSyncHooksDisabler"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.DefaultProjectSyncHooksDisabler"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectStructureProvider"
                        interface="org.jetbrains.plugins.bsp.projectStructure.ProjectStructureProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.startBuiltInServerExtension"
                        interface="org.jetbrains.plugins.bsp.impl.server.client.BspServerProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.runConfigurationTypeProvider"
                        interface="org.jetbrains.plugins.bsp.run.config.BspRunConfigurationTypeProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspFeatureFlagsProvider"
                        interface="org.jetbrains.plugins.bsp.config.BspFeatureFlagsProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspAdditionalProjectTaskRunnerProvider"
                        interface="org.jetbrains.plugins.bsp.buildTask.BspAdditionalProjectTaskRunnerProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspTreeStructureSettingsExtension"
                        interface="org.jetbrains.plugins.bsp.ui.projectTree.BspTreeStructureSettingsProvider"
                        dynamic="true"/>
    </extensionPoints>

    <extensions defaultExtensionNs="org.jetbrains.bsp">
        <buildToolAssetsExtension
                implementation="org.jetbrains.plugins.bsp.assets.BspAssetsExtension"/>

        <buildTargetClassifierExtension
                implementation="org.jetbrains.plugins.bsp.extensionPoints.DefaultBuildTargetClassifierExtension"/>

        <connectionDetailsProviderExtension
                implementation="org.jetbrains.plugins.bsp.impl.server.connection.DefaultConnectionDetailsProviderExtension"/>

        <bspRunHandlerProvider implementation="org.jetbrains.plugins.bsp.jvm.JvmBspRunHandler$JvmBspRunHandlerProvider"
                               id="JvmRunHandlerProvider"/>
        <bspRunHandlerProvider
                implementation="org.jetbrains.plugins.bsp.jvm.JvmBspTestHandler$JvmBspTestHandlerProvider"
                id="JvmTestHandlerProvider"/>
        <bspRunHandlerProvider implementation="org.jetbrains.plugins.bsp.run.handler.GenericBspRunHandlerProvider"
                               order="last"/>
        <bspRunHandlerProvider implementation="org.jetbrains.plugins.bsp.run.handler.GenericBspTestHandlerProvider"
                               order="last"/>
        <projectSyncHook implementation="org.jetbrains.plugins.bsp.projectDetails.CollectProjectDetailsSyncHook"/>
        <projectSyncHook implementation="org.jetbrains.plugins.bsp.impl.flow.sync.OutputPathUrisSyncHook"/>
        <projectStructureProvider
                implementation="org.jetbrains.plugins.bsp.projectStructure.workspaceModel.WorkspaceModelProjectStructureProvider"/>
        <runConfigurationTypeProvider
                implementation="org.jetbrains.plugins.bsp.run.config.DefaultBspRunConfigurationTypeProvider"/>
        <bspFeatureFlagsProvider implementation="org.jetbrains.plugins.bsp.config.DefaultBspFeatureFlagsProvider"/>
        <sourceTypeIconProvider implementation="org.jetbrains.plugins.bsp.java.JavaSourceTypeIconProvider"/>
        <sourceTypeIconProvider implementation="org.jetbrains.plugins.bsp.kotlin.KotlinSourceTypeIconProvider"/>
    </extensions>

    <extensions defaultExtensionNs="com.intellij">

        <activityTracker implementation="org.jetbrains.plugins.bsp.startup.BspStartupActivityTracker"/>

        <projectService serviceInterface="com.intellij.openapi.project.BaseProjectDirectories"
                        serviceImplementation="org.jetbrains.plugins.bsp.services.BspBaseProjectDirectories"
                        overrides="true"/>
        <projectService serviceInterface="com.intellij.codeInsight.ExternalAnnotationsManager"
                        serviceImplementation="org.jetbrains.plugins.bsp.services.BspExternalAnnotationsManager"
                        overrides="true"/>
        <moduleService serviceInterface="com.intellij.openapi.roots.ModuleFileIndex"
                       serviceImplementation="org.jetbrains.plugins.bsp.services.BspModuleFileIndex"
                       overrides="true"/>

        <commandLineInspectionProjectConfigurator
                implementation="org.jetbrains.plugins.bsp.startup.BspCommandLineInspectionConfigurator"/>
        <configurationType implementation="org.jetbrains.plugins.bsp.run.config.BspRunConfigurationType"/>

        <notificationGroup id="Bazel" displayType="STICKY_BALLOON"/>

        <workspaceModel.fileIndexContributor
                implementation="org.jetbrains.plugins.bsp.workspace.BspProjectDirectoriesWorkspaceFileIndexContributor"/>
        <!--        <workspaceModel.fileIndexContributor-->
        <!--                implementation="org.jetbrains.plugins.bsp.workspace.DummyModuleExclusionWorkspaceFileIndexContributor"/>-->
        <fileTypeOverrider
                implementation="org.jetbrains.plugins.bsp.workspace.DummyModuleSourcePlainTextTypeOverrider"/>
        <fileType name="BSP_PLAIN_TEXT"
                  language="TEXT"
                  implementationClass="org.jetbrains.plugins.bsp.workspace.BspPlainTextFileType"
                  fieldName="INSTANCE"/>
        <workspaceModel.fileIndexContributor
                implementation="org.jetbrains.plugins.bsp.workspace.CompiledSourceCodeInsideJarExcludeWorkspaceFileIndexContributor"/>

        <java.programPatcher implementation="org.jetbrains.plugins.bsp.jvm.BspJvmEnvironmentProgramPatcher"/>
        <java.elementFinder implementation="org.jetbrains.plugins.bsp.services.GeneratedClassFinder"/>

        <projectOpenProcessor
                implementation="org.jetbrains.plugins.bsp.impl.flow.open.BspProjectOpenProcessor"/>

        <postStartupActivity
                implementation="org.jetbrains.plugins.bsp.startup.BspStartupActivity"/>

        <treeStructureProvider implementation="org.jetbrains.plugins.bsp.ui.projectTree.BspTreeStructureProvider"/>
        <projectViewNodeDecorator
                implementation="org.jetbrains.plugins.bsp.ui.projectTree.BspProjectViewNodeDecorator"/>
        <projectTaskRunner
                implementation="org.jetbrains.plugins.bsp.buildTask.BspProjectTaskRunner"/>
        <programRunner implementation="org.jetbrains.plugins.bsp.jvm.BspJvmDebugRunner"/>

        <directoryProjectConfigurator
                implementation="org.jetbrains.plugins.bsp.impl.flow.open.CounterPlatformProjectConfigurator"
                order="last"/>

        <!--    <projectService serviceInterface="com.intellij.openapi.roots.SingleFileSourcesTracker"-->
        <!--                    serviceImplementation="org.jetbrains.plugins.bsp.services.SingleFileSourcesTrackerImpl"-->
        <!--                    overrides="true"/>-->

        <runLineMarkerContributor
                implementationClass="org.jetbrains.plugins.bsp.ui.gutters.BspJVMRunLineMarkerContributor"
                language="JVM"/>
        <registryKey defaultValue="600" description="Timeout for BSP requests in seconds"
                     key="bsp.request.timeout.seconds"/>
        <registryKey defaultValue="true" description="Choose default connection"
                     key="bsp.wizard.choose.default.connection"/>
        <registryKey defaultValue="true" description="Enable chunking for BSP requests"
                     key="bsp.request.chunking.enable"/>
        <registryKey defaultValue="100" description="Minimum chunk size for chunked BSP requests"
                     key="bsp.request.chunking.size.min"/>
        <registryKey defaultValue="true" description="Log error outputs from processes to build/sync console"
                     key="bsp.log.error.outputs"/>
        <registryKey defaultValue="false" description="Build project on initial project sync"
                     key="bsp.build.project.on.sync"/>
        <registryKey defaultValue="false" description="Python modules support" key="bsp.python.support"/>
        <registryKey defaultValue="false" description="Enable JPS compilation" key="bsp.jps.compilation.enable"/>
        <registryKey defaultValue="false" description="Android modules support" key="bsp.android.support"/>
        <registryKey defaultValue="false" description="Go modules support" key="bsp.go.support"/>
        <registryKey defaultValue="true"
                     description="Shorten module/library names by hashing the first parts and retaining the others"
                     key="bsp.shorten.module.library.names"/>
        <registryKey defaultValue="false"
                     description="Retrieve targets for file from its ancestors"
                     key="bsp.retrieve.targets.for.file.from.ancestors"/>
        <registryKey defaultValue="false"
                     description="Wrap libraries inside modules to form a proper dependency graph between libraries. Enabled by default with K2 mode"
                     key="bsp.wrap.libraries.inside.modules"/>
        <registryKey defaultValue="false"
                     description="Enable phased sync. Phased sync consists of multiple steps, making code available sooner with limited dependency resolution"
                     key="bsp.use.phased.sync"/>
        <registryKey defaultValue="true"
                     description="Execute second phase of the phased sync. `bsp.use.phased.sync` has to be enabled to use this flag. It should be used only for testing purposes."
                     key="bsp.execute.second.phase.on.sync"/>
        <registryKey defaultValue="true"
                     description="Add the so-called &quot;dummy&quot; modules to make Java resolve work correctly."
                     key="bsp.add.dummy.modules"/>
        <registryKey defaultValue="true"
                     description="Exclude class files inside jars (and source files inside source jars) if they match up with a source file in the current project."
                     key="bsp.exclude.compiled.source.code.inside.jars"/>

        <statusBarWidgetFactory id="BspFileTargetsWidget"
                                implementation="org.jetbrains.plugins.bsp.ui.widgets.fileTargets.BspFileTargetsWidgetFactory"/>

        <toolWindowAllowlist id="BSP"/>
        <toolWindowExtractor
                implementation="org.jetbrains.plugins.bsp.ui.widgets.tool.window.all.targets.BspToolWindowViewModelExtractor"/>

        <consoleFilterProvider implementation="org.jetbrains.plugins.bsp.console.BspConsoleFilterProvider"/>

        <iconMapper mappingFile="BSPIconMappings.json"/>

        <notificationGroup displayType="BALLOON" id="BSP Plugin"/>
        <editorNotificationProvider
                implementation="org.jetbrains.plugins.bsp.ui.notifications.BuildAndResyncOnUnresolvedImportNotificationsProvider"/>
    </extensions>

    <extensions defaultExtensionNs="org.jetbrains.kotlin">
        <projectConfigurator
                implementation="org.jetbrains.plugins.bsp.kotlin.BspKotlinProjectConfigurator"
                order="first"
        />

        <!--suppress PluginXmlValidity -->
        <supportsKotlinPluginMode supportsK2="true"/>

        <!-- this is left for backward-compatibility with the first versions of 242,
        it can be removed later -->
        <!--suppress PluginXmlValidity -->
        <supportsKotlinK2Mode/>
    </extensions>

    <actions>
        <action class="org.jetbrains.plugins.bsp.ui.projectTree.action.RunAllTestsAction">
            <add-to-group group-id="EditorPopupMenu" anchor="last"/>
            <add-to-group group-id="ProjectViewPopupMenu" anchor="last"/>
        </action>
        <action id="Bsp.DisconnectAction" class="org.jetbrains.plugins.bsp.impl.actions.registered.DisconnectAction"
                icon="/icons/disconnect.svg"/>
        <action id="Bsp.ResyncAction" class="org.jetbrains.plugins.bsp.impl.actions.registered.ResyncAction"
                icon="/icons/resync.svg"/>
        <action id="Bsp.BuildAndResyncAction"
                class="org.jetbrains.plugins.bsp.impl.actions.registered.BuildAndResyncAction"
                icon="/icons/buildAndResync.svg"/>
        <action id="Bsp.Compile.CompileProjectWithBspAction"
                class="org.jetbrains.plugins.bsp.building.action.CompileProjectWithBspAction"
                icon="AllIcons.Actions.Compile"/>
        <action id="Bsp.Compile.CompileProjectWithJpsAction"
                class="org.jetbrains.plugins.bsp.building.action.CompileProjectWithJpsAction"
                icon="AllIcons.Actions.Compile"/>

        <group id="Bsp.ActionsToolbar">
            <reference id="Bsp.ResyncAction"/>
            <reference id="Bsp.BuildAndResyncAction"/>
        </group>

    </actions>

    <applicationListeners>
        <listener class="org.jetbrains.plugins.bsp.impl.flow.close.ProjectClosingListener"
                  topic="com.intellij.openapi.project.ProjectManagerListener"/>

        <listener class="org.jetbrains.plugins.bsp.workspace.AssignFileToModuleListener"
                  topic="com.intellij.openapi.vfs.newvfs.BulkFileListener"/>
    </applicationListeners>
</idea-plugin>
