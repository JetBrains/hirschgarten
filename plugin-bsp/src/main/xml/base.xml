<idea-plugin>
    <!-- Do NOT put <id> and <name> here, it will be provided by the xml generated by rules_intellij -->
    <!-- which will be merged with this one -->
    <vendor>JetBrains</vendor>
    <extensionPoints>
        <extensionPoint qualifiedName="org.jetbrains.bsp.buildTargetClassifierExtension"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BuildTargetClassifierExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.pythonSdkGetterExtension"
                        interface="org.jetbrains.plugins.bsp.python.PythonSdkGetterExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.scalaSdkExtension"
                        interface="org.jetbrains.plugins.bsp.scala.sdk.ScalaSdkExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.androidSdkGetterExtension"
                        interface="org.jetbrains.plugins.bsp.android.AndroidSdkGetterExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.androidFacetEntityUpdaterExtension"
                        interface="org.jetbrains.plugins.bsp.impl.magicmetamodel.impl.workspacemodel.impl.updaters.AndroidFacetEntityUpdaterExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspRunHandlerProvider"
                        interface="org.jetbrains.plugins.bsp.run.BspRunHandlerProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspProjectOpenProcessorExtension"
                        interface="org.jetbrains.plugins.bsp.impl.flow.open.BspProjectOpenProcessorExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.buildToolAssetsExtension"
                        interface="org.jetbrains.plugins.bsp.assets.BuildToolAssetsExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspProjectAwareExtension"
                        interface="org.jetbrains.plugins.bsp.impl.projectAware.BspProjectAwareExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.connectionDetailsProviderExtension"
                        interface="org.jetbrains.plugins.bsp.impl.server.connection.ConnectionDetailsProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.connectionDetailsProviderExtensionJavaShim"
                        interface="org.jetbrains.plugins.bsp.impl.server.connection.ConnectionDetailsProviderExtensionJavaShim"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.buildToolWindowTargetActionProviderExtension"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BuildToolWindowTargetActionProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspToolWindowSettingsProviderExtension"
                        interface="org.jetbrains.plugins.bsp.extensionPoints.BspToolWindowSettingsProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.bspRunConfigurationExtension"
                        interface="org.jetbrains.plugins.bsp.run.config.BspRunConfigurationExtensionManager"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.invalidTargetsProviderExtension"
                        interface="org.jetbrains.plugins.bsp.services.InvalidTargetsProviderExtension"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectSyncHook"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.ProjectSyncHook"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectPreSyncHook"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.ProjectPreSyncHook"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectPostSyncHook"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.ProjectPostSyncHook"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.defaultProjectSyncHooksDisabler"
                        interface="org.jetbrains.plugins.bsp.impl.flow.sync.DefaultProjectSyncHooksDisabler"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.projectStructureProvider"
                        interface="org.jetbrains.plugins.bsp.projectStructure.ProjectStructureProvider"
                        dynamic="true"/>
        <extensionPoint qualifiedName="org.jetbrains.bsp.startBuiltInServerExtension"
                        interface="org.jetbrains.plugins.bsp.impl.server.client.BspServerProvider"
                        dynamic="true"/>
    </extensionPoints>

    <extensions defaultExtensionNs="org.jetbrains.bsp">
        <buildToolAssetsExtension
                implementation="org.jetbrains.plugins.bsp.assets.BspAssetsExtension"/>

        <buildTargetClassifierExtension
                implementation="org.jetbrains.plugins.bsp.extensionPoints.DefaultBuildTargetClassifierExtension"/>

        <connectionDetailsProviderExtension
                implementation="org.jetbrains.plugins.bsp.impl.server.connection.DefaultConnectionDetailsProviderExtension"/>

        <bspRunHandlerProvider implementation="org.jetbrains.plugins.bsp.jvm.JvmBspRunHandler$JvmBspRunHandlerProvider" id="JvmRunHandlerProvider"/>
        <bspRunHandlerProvider implementation="org.jetbrains.plugins.bsp.run.handler.GenericBspRunHandlerProvider" order="last"/>
        <bspRunHandlerProvider implementation="org.jetbrains.plugins.bsp.run.handler.GenericBspTestHandlerProvider" order="last"/>
        <projectSyncHook implementation="org.jetbrains.plugins.bsp.projectDetails.CollectProjectDetailsSyncHook"/>
        <projectSyncHook implementation="org.jetbrains.plugins.bsp.impl.flow.sync.OutputPathUrisSyncHook"/>
        <projectStructureProvider implementation="org.jetbrains.plugins.bsp.projectStructure.workspaceModel.WorkspaceModelProjectStructureProvider"/>
    </extensions>

    <extensions defaultExtensionNs="com.intellij">

        <activityTracker implementation="org.jetbrains.plugins.bsp.startup.BspStartupActivityTracker"/>

        <projectService serviceInterface="com.intellij.openapi.project.BaseProjectDirectories"
                        serviceImplementation="org.jetbrains.plugins.bsp.services.BspBaseProjectDirectories"
                        overrides="true"/>
        <projectService serviceInterface="com.intellij.codeInsight.ExternalAnnotationsManager"
                        serviceImplementation="org.jetbrains.plugins.bsp.services.BspExternalAnnotationsManager"
                        overrides="true"/>
        <moduleService serviceInterface="com.intellij.openapi.roots.ModuleFileIndex"
                       serviceImplementation="org.jetbrains.plugins.bsp.services.BspModuleFileIndex"
                       overrides="true"/>

        <commandLineInspectionProjectConfigurator
                implementation="org.jetbrains.plugins.bsp.startup.BspCommandLineInspectionConfigurator"/>
        <configurationType implementation="org.jetbrains.plugins.bsp.run.config.BspRunConfigurationType"/>

        <notificationGroup id="Bazel BSP" displayType="STICKY_BALLOON"/>

        <workspaceModel.fileIndexContributor
                implementation="org.jetbrains.plugins.bsp.workspace.BspProjectDirectoriesWorkspaceFileIndexContributor"/>
        <workspaceModel.fileIndexContributor
                implementation="org.jetbrains.plugins.bsp.workspace.DummyModuleExclusionWorkspaceFileIndexContributor"/>

        <java.programPatcher implementation="org.jetbrains.plugins.bsp.jvm.BspJvmEnvironmentProgramPatcher"/>
        <java.elementFinder implementation="org.jetbrains.plugins.bsp.services.GeneratedClassFinder"/>

        <projectOpenProcessor
                implementation="org.jetbrains.plugins.bsp.impl.flow.open.BspProjectOpenProcessor"/>

        <postStartupActivity
                implementation="org.jetbrains.plugins.bsp.startup.BspStartupActivity"/>

        <stepsBeforeRunProvider implementation="org.jetbrains.plugins.bsp.runnerAction.BuildBeforeLocalRunTaskProvider" />

        <treeStructureProvider implementation="org.jetbrains.plugins.bsp.ui.project.tree.BspTreeStructureProvider"/>
        <projectViewNodeDecorator
                implementation="org.jetbrains.plugins.bsp.ui.project.tree.BspProjectViewNodeDecorator"/>
        <projectTaskRunner
                implementation="org.jetbrains.plugins.bsp.buildTask.BspProjectTaskRunner"/>
        <programRunner implementation="org.jetbrains.plugins.bsp.jvm.BspJvmDebugRunner"/>

        <directoryProjectConfigurator
                implementation="org.jetbrains.plugins.bsp.impl.flow.open.CounterPlatformProjectConfigurator"
                order="last"/>

        <!--    <projectService serviceInterface="com.intellij.openapi.roots.SingleFileSourcesTracker"-->
        <!--                    serviceImplementation="org.jetbrains.plugins.bsp.services.SingleFileSourcesTrackerImpl"-->
        <!--                    overrides="true"/>-->

        <runLineMarkerContributor
                implementationClass="org.jetbrains.plugins.bsp.ui.gutters.BspJVMRunLineMarkerContributor"
                language="JVM"/>
        <registryKey defaultValue="600" description="Timeout for BSP requests in seconds"
                     key="bsp.request.timeout.seconds"/>
        <registryKey defaultValue="true" description="Choose default connection"
                     key="bsp.wizard.choose.default.connection"/>
        <registryKey defaultValue="true" description="Enable chunking for BSP requests"
                     key="bsp.request.chunking.enable"/>
        <registryKey defaultValue="100" description="Minimum chunk size for chunked BSP requests"
                     key="bsp.request.chunking.size.min"/>
        <registryKey defaultValue="true" description="Log error outputs from processes to build/sync console"
                     key="bsp.log.error.outputs"/>
        <registryKey defaultValue="false" description="Build project on initial project sync"
                     key="bsp.build.project.on.sync"/>
        <registryKey defaultValue="false" description="Python modules support" key="bsp.python.support"/>
        <registryKey defaultValue="false" description="Default to use JPS to build project instead of build tool"
                     key="bsp.jps.compilation.default"/>
        <registryKey defaultValue="false" description="Enable JPS compilation" key="bsp.jps.compilation.enable"/>
        <registryKey defaultValue="false" description="Android modules support" key="bsp.android.support"/>
        <registryKey defaultValue="false" description="Go modules support" key="bsp.go.support"/>
        <registryKey defaultValue="false"
                     description="Shorten module/library names by hashing the first parts and retaining the others"
                     key="bsp.shorten.module.library.names"/>
        <registryKey defaultValue="false"
                     description="Retrieve targets for file from its ancestors"
                     key="bsp.retrieve.targets.for.file.from.ancestors"/>
        <registryKey defaultValue="false"
                     description="Wrap libraries inside modules to form a proper dependency graph between libraries"
                     key="bsp.wrap.libraries.inside.modules"/>

        <statusBarWidgetFactory id="BspFileTargetsWidget"
                                implementation="org.jetbrains.plugins.bsp.ui.widgets.file.targets.BspFileTargetsWidgetFactory"/>

        <toolWindowAllowlist id="BSP"/>
        <toolWindowExtractor implementation="org.jetbrains.plugins.bsp.ui.widgets.tool.window.all.targets.BspToolWindowViewModelExtractor"/>

        <iconMapper mappingFile="BSPIconMappings.json"/>

        <notificationGroup displayType="BALLOON" id="BSP Plugin"/>

    </extensions>

    <extensions defaultExtensionNs="org.jetbrains.kotlin">
        <projectConfigurator
                implementation="org.jetbrains.plugins.bsp.kotlin.BspKotlinProjectConfigurator"
                order="first"
        />

        <!--suppress PluginXmlValidity -->
        <supportsKotlinPluginMode supportsK2="true"/>

        <!-- this is left for backward-compatibility with the first versions of 242,
        it can be removed later -->
        <!--suppress PluginXmlValidity -->
        <supportsKotlinK2Mode/>
    </extensions>

    <actions>
        <action id="Bsp.DisconnectAction" class="org.jetbrains.plugins.bsp.impl.actions.registered.DisconnectAction"
                icon="/icons/disconnect.svg"/>
        <action id="Bsp.ResyncAction" class="org.jetbrains.plugins.bsp.impl.actions.registered.ResyncAction"
                icon="/icons/resync.svg"/>
        <action id="Bsp.BuildAndResyncAction"
                class="org.jetbrains.plugins.bsp.impl.actions.registered.BuildAndResyncAction"
                icon="/icons/buildAndResync.svg"/>
        <action id="Bsp.Compile.CompileProjectWithBspAction"
                class="org.jetbrains.plugins.bsp.building.action.CompileProjectWithBspAction"
                icon="AllIcons.Actions.Compile"/>
        <action id="Bsp.Compile.CompileProjectWithJpsAction"
                class="org.jetbrains.plugins.bsp.building.action.CompileProjectWithJpsAction"
                icon="AllIcons.Actions.Compile"/>

        <group id="Bsp.ActionsToolbar">
            <reference id="Bsp.ResyncAction"/>
            <reference id="Bsp.BuildAndResyncAction"/>
        </group>

    </actions>

    <applicationListeners>
        <listener class="org.jetbrains.plugins.bsp.impl.flow.close.ProjectClosingListener"
                  topic="com.intellij.openapi.project.ProjectManagerListener"/>

        <listener class="org.jetbrains.plugins.bsp.workspace.AssignFileToModuleListener"
                  topic="com.intellij.openapi.vfs.newvfs.BulkFileListener"/>
    </applicationListeners>
</idea-plugin>
