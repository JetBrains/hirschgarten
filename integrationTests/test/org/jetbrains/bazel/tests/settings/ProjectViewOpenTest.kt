package org.jetbrains.bazel.tests.settings

import com.intellij.driver.sdk.step
import com.intellij.driver.sdk.ui.components.common.editorTabs
import com.intellij.driver.sdk.ui.components.common.gutter
import com.intellij.driver.sdk.ui.components.common.ideFrame
import com.intellij.driver.sdk.ui.components.elements.popup
import com.intellij.driver.sdk.ui.shouldBe
import com.intellij.driver.sdk.waitForIndicators
import com.intellij.ide.starter.driver.engine.runIdeWithDriver
import org.jetbrains.bazel.data.IdeaBazelCases
import org.jetbrains.bazel.ideStarter.IdeStarterBaseProjectTest
import org.jetbrains.bazel.ideStarter.openFile
import org.jetbrains.bazel.ideStarter.syncBazelProject
import org.junit.jupiter.api.Test
import kotlin.time.Duration.Companion.minutes

/**
 * ```sh
 * bazel test //plugin-bazel/src/test/kotlin/org/jetbrains/bazel/settings:project_view_open_test --jvmopt="-Dbazel.ide.starter.test.cache.directory=$HOME/IdeaProjects/hirschgarten" --sandbox_writable_path=/ --action_env=PATH --java_debug --test_arg=--wrapper_script_flag=--debug=8000
 * ```
 */
class ProjectViewOpenTest : IdeStarterBaseProjectTest() {
  @Test
  fun openBazelProject() {
    createContext("projectViewOpen", IdeaBazelCases.ProjectViewOpen).runIdeWithDriver(runTimeout = timeout).useDriverAndCloseIde {
      ideFrame {
        syncBazelProject()
        waitForIndicators(5.minutes)

        shouldBe("README.md should be opened") {
          editorTabs().isTabOpened("README.md")
        }
        shouldBe("projectview.bazelproject should be opened") {
          editorTabs().isTabOpened("projectview.bazelproject")
        }

        // Added here because SimpleJavaCombinedTest doesn't exist on 253 branch
        step("Open BUILD file") {
          openFile("BUILD")
        }
        step("Check run gutters for test suite") {
          editorTabs()
            .gutter()
            .getGutterIcons()
            .first()
            .click()
          val expectedTexts = listOf(
            "Run all tests",
            "Test //:SimpleTest",
            "Test //:Simple2Test",
          )
          for (text in expectedTexts) {
            step("Checking that run gutter contains run config with name: $text") {
              popup().waitAnyTextsContains(text)
            }
          }
          popup().close()
        }
      }
    }
  }
}
